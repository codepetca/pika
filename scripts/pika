#!/bin/bash
# pika — worktree router for agent-safe workflows (v1)
# Usage: pika ls | pika ai <worktree> | pika git <worktree> <args...>

set -euo pipefail

WORKTREE_ROOT="$HOME/Repos/.worktrees/pika"

die() {
    echo "error: $1" >&2
    echo "" >&2
    echo "Available worktrees:" >&2
    ls -1 "$WORKTREE_ROOT" 2>/dev/null || echo "  (none)" >&2
    exit 1
}

cmd_ls() {
    if [[ -d "$WORKTREE_ROOT" ]]; then
        ls -1 "$WORKTREE_ROOT"
    else
        echo "(no worktrees found)"
    fi
}

cmd_ai() {
    local name="$1"
    local path="$WORKTREE_ROOT/$name"

    [[ -d "$path" ]] || die "worktree '$name' does not exist"

    export PIKA_PROJECT="pika"
    export PIKA_WORKTREE="$path"
    export PIKA_WORKTREE_NAME="$name"

    exec claude
}

cmd_git() {
    local name="$1"
    shift
    local path="$WORKTREE_ROOT/$name"

    [[ -d "$path" ]] || die "worktree '$name' does not exist"

    exec git -C "$path" "$@"
}

# Main dispatch
case "${1:-}" in
    ls)
        cmd_ls
        ;;
    ai)
        [[ -n "${2:-}" ]] || die "usage: pika ai <worktree>"
        cmd_ai "$2"
        ;;
    git)
        [[ -n "${2:-}" ]] || die "usage: pika git <worktree> <git args...>"
        cmd_git "${@:2}"
        ;;
    *)
        echo "pika — worktree router (v1)"
        echo ""
        echo "Commands:"
        echo "  pika ls                    List available worktrees"
        echo "  pika ai <worktree>         Launch Claude in worktree context"
        echo "  pika git <worktree> ...    Run git command in worktree"
        exit 1
        ;;
esac
